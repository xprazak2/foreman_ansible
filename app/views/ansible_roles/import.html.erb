<% title _("Changed Ansible roles") %>
<%= webpacked_plugins_js_for :foreman_ansible %>

<% my_rows = [] %>
<% changed.each do |kind, roles| %>
  <% roles.each do |role| %>

    <% action =  { "new" => _("Import Role "), "obsolete" => _("Remove Role"), "old" => _("Update Role Variables")}[kind] %>
    <% if kind == "new" %>
      <% variables = {"Add" => @importer.get_variables_names(role)[role.name]} %>
    <% elsif  kind =="obsolete" %>
      <% variables= {"Remove" => role.ansible_variables.map {|variable| variable.key}} %>
    <% elsif kind == "old" %>
      <% variables = {"Add" => [],"Remove" => [],"Update" =>[]} %>
      <%  imported_variables = @variables_importer.import_variable_names(roles)%>
      <% imported_variables.each do |kind,temp_variables| %>
        <% variable_action =  { "new" => _("Add"), "obsolete" => _("Remove"), "update" => _("Update")}[kind] %>
        <% temp_variables.each do |temp_variable| %>
          <%  if temp_variable.ansible_role_id == role.id%>
            <% variables[variable_action].append(temp_variable.key) %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
    <% string_variables ="" %>
    <% variables.each do |action, temp_variables| %>
      <% unless temp_variables.empty? %>
        <% string_variables += "#{action}: #{temp_variables.size()} " %>
      <% end %>
    <% end %>
    <% unless string_variables.empty? %>
      <% my_rows.append({
                            cells: [role.name,action, string_variables, action == "Remove Role" ? role.hosts.count: "", action == "Remove Role" ? role.hostgroups.count: "", ],
                            role: role, kind: kind, id:role.name})
      %>
    <% end %>
  <% end %>
<% end %>
<% cols =  [
    {title: 'Name'},
    {title:'Operation'},
    {title:'Variables'},
    {title:'Hosts Count'},
    {title:'Hostgroups count'},
] %>

<%= react_component(
        'ImportRolesAndVariablesTable',
        :rowsData => my_rows,
        :columnsData => cols,
        :proxy => @proxy.id
    ) %>

